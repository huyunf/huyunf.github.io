<!DOCTYPE html>
<html lang="english">
<head>

        <title>x264 Overview</title>
        <meta charset="utf-8" />


        <!-- Mobile viewport optimized: j.mp/bplateviewport -->
        <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1">

        <link rel="stylesheet" type="text/css" href="https://huyunf.github.io/theme/gumby.css" />
        <link rel="stylesheet" type="text/css" href="https://huyunf.github.io/theme/style.css" />
        <link rel="stylesheet" type="text/css" href="https://huyunf.github.io/theme/pygment.css" />

        <script src="https://huyunf.github.io/theme/js/libs/modernizr-2.6.2.min.js"></script>




</head>

<body id="index" class="home">


    <div class="container">

        <div class="row">

          <header id="banner" class="body">
                  <h1><a href="https://huyunf.github.io/">Everyday One Step Forward <strong></strong></a></h1>
          </header><!-- /#banner -->

            <div id="navigation" class="navbar row">
              <a href="#" gumby-trigger="#navigation &gt; ul" class="toggle"><i class="icon-menu"></i></a>
             
              <ul class="columns">
                <li><a href="https://huyunf.github.io/">Home</a></li>

                <li><a href="https://huyunf.github.io/category/life.html">Life</a></li>
                <li class="active"><a href="https://huyunf.github.io/category/technology.html">Technology</a></li>
            <li><a href="https://huyunf.github.io/archives.html">Archives</a>
              </ul>
            </div>

<section id="content" class="body">

   <div class="row">
        <div class="eleven columns">


            <header>
              <h2 class="entry-title">
                <a href="https://huyunf.github.io/blogs/2017/11/14/x264_overview/" rel="bookmark"
                   title="Permalink to x264 Overview">x264 Overview</a></h2>
           
            </header>
            <footer class="post-info">
              <abbr class="published" title="2017-11-14T22:29:00-08:00">
                Tue 14 November 2017
              </abbr>
              <address class="vcard author">By 
                <a class="url fn" href="https://huyunf.github.io/author/yf.html"> YF</a>
              </address>
            </footer><!-- /.post-info -->
            <div class="entry-content">
              <h3><strong>Introduction</strong></h3>
<hr>
<p>x264 version compilable by visual studio, generated by <a href="https://shiftmediaproject.github.io/">Shift Media Project</a> I have forked my own version and put it in my github website: git@github.com:huyunf/x264.git</p>
<h3><strong>Code Overview</strong></h3>
<hr>
<div class="highlight"><pre><span></span>h = x264_encoder_open( );

for(loop by frame number){
    ...
    encode_frame( );
    ...
}
</pre></div>


<p>The <code>x264_encoder_open()</code> function does several initial task for the following encoding process. For more detail, please refer to <a href="https://huyunf.github.io/blogs/2017/11/20/x264_encoder_open/">x264 Encoder Open</a> </p>
<h3><strong>x264_encoder_encode</strong></h3>
<hr>
<p>The <code>encode_frame()</code> will lead to <code>x264_encoder_encode</code>, which is the true main encoding funcion. In <code>x264_encoder_encode</code>, it </p>
<ol>
<li>prepare thread for encoding task</li>
<li>
<p>setup new frame from picture list</p>
<ul>
<li>setting frame parameters like resolution, picture structure. etc</li>
<li>initial parameters for <span style="color:green;">adaptive MB level quantization</span> by calling function <code>x264_adaptive_quant_frame</code>. For detail algorithm please refer to <a href="https://huyunf.github.io/blogs/2017/12/06/x264_adaptive_quant/">x264 Adaptive Quant</a></li>
<li>prepare low resolution frame for zero pass <code>x264_frame_init_lowres</code></li>
<li>put frame into process queue <code>x264_lookahead_put_frame</code>. If enable multiple thread, each thread will get frame from the list and start their own process</li>
</ul>
<p>The prepare process should fill the <span style="color:green;">prepare frame list</span>. And the number of frame need to input to the list is decided by</p>
<div class="highlight"><pre><span></span>    if( h-&gt;frames.i_input &lt;= h-&gt;frames.i_delay + 1 - h-&gt;i_thread_frames )
    {
        ...
        return 0;
    }
</pre></div>


</li>
<li>
<p>analyze picture in lookahead <code>x264_lookahead_get_frames</code>, mainly for get slice type</p>
<ul>
<li>decide slice type <code>x264_slicetype_decide</code>. For more detail about the x264 slice type decision algorithm. Please refer to <a href="https://huyunf.github.io/blogs/2017/12/06/x264_slice_type_decision/">x264 Slice Type Decision</a></li>
</ul>
</li>
<li>
<p>several top level syntax process, like reference list prepare <code>x264_reference_build_list</code>, nal structure prepare. etc</p>
</li>
<li>
<p>bit stream structure bs prepare <code>bs_init</code>, write header if necessary:</p>
<ul>
<li>aud</li>
<li>if key frame, write SPS and PPS</li>
<li>period sei, extra sei, pic timing sei, sei for blu-ray. etc</li>
</ul>
</li>
<li>
<p>perform rate control <code>x264_ratecontrol_start</code> and get the global qp <code>x264_ratecontrol_qp</code>. For more detail of x264 rate control, please refer to <a href="https://huyunf.github.io/blogs/2017/12/05/x264_rate_control/">x264 rate control</a></p>
</li>
<li>
<p>initial slice header <code>x264_slice_init</code></p>
</li>
<li>
<p>weighted prediction prepare <code>x264_macroblock_bipred_init</code> for B frame and <code>x264_weighted_pred_init</code></p>
<p>Brief summery of algorithm in <code>x264_macroblock_bipred_init</code>. poc0 and poc1 represent the poc number from forward reference list and backward reference list.</p>
<div class="highlight"><pre><span></span>td = x264_clip3( poc1 - poc0, -128, 127 );
if( td == 0 /* || pic0 is a long-term ref */ )
    dist_scale_factor = 256;
else
{
    int tb = x264_clip3( cur_poc - poc0, -128, 127 );
    int tx = (16384 + (abs(td) &gt;&gt; 1)) / td;
    dist_scale_factor = x264_clip3( (tb * tx + 32) &gt;&gt; 6, -1024, 1023 );
}
</pre></div>


<p>|&lt;--------tb----------&gt;| </p>
<p>|----------------------|-----|</p>
<p>|&lt;-------------td-----------&gt;|</p>
<p>tx = 16k / td</p>
<p>dist_scale_factor = tb/td (multiple 16k to extend dynamic range)</p>
</li>
<li>
<p>slice encoding entry <code>x264_slices_write</code> or <code>x264_threaded_slices_write</code> when multiple thread pool enabled</p>
</li>
</ol>
<h3><strong>x264_slice_write</strong></h3>
<hr>
<p>The <code>x264_slices_write</code> contain a while loop which will deal with each slice of the frame. It will first gt <code>i_first_mb</code> and <code>i_last_mb</code> for slice header and then call slice encoding function <code>x264_slice_write</code></p>
<div class="highlight"><pre><span></span>    static void *x264_slices_write( x264_t *h )
    {
        while( h-&gt;sh.i_first_mb + SLICE_MBAFF*h-&gt;mb.i_mb_stride &lt;= last_thread_mb )
        {
            //... h-&gt;sh.i_last_mb;
            if( x264_stack_align( x264_slice_write, h ) )
                goto fail;
            //... h-&gt;sh.i_first_mb
        }
    }
</pre></div>


<p>In function <code>x264_slice_write</code>, the real encoding process happened</p>
<ol>
<li>
<p>get slice level qp from rate control <code>x264_ratecontrol_mb_qp</code></p>
</li>
<li>
<p>write slice header <code>x264_slice_header_write</code></p>
</li>
<li>
<p>if cabac enabled, several cabac initial step <code>x264_cabac_context_init</code> and <code>x264_cabac_encode_init</code>, which initiate the cabac context according to <em>slice type</em> and <em>qp value</em></p>
</li>
</ol>
<p>Then there goes to the while loop for encoding each mb (i_first_mb to i_last_mb)</p>
<ol>
<li>
<p>do the hpel &amp; deblocking for top row <code>x264_fdec_filter_row</code></p>
</li>
<li>
<p>load cache data for each MB, <code>x264_macroblock_cache_load_xxx</code>. In this function, decoder prepare the context of top and left MB data if necessary. Most data store in <code>x264_t.mb.cache</code></p>
</li>
<li>
<p>macroblock analyse <code>x264_macroblock_analyse</code>, which doing so-called Mode decision. The decision choose the best rdo mode from intra &amp; inter separately and then select the better from intra &amp; inter. For more detail of the analyse, please refer to <a href="https://huyunf.github.io/blogs/2017/12/12/x264_mb_analyse_and_coding/">x264 MB Analyse and Coding</a></p>
</li>
<li>
<p>following is real encoding process <code>x264_macroblock_encode</code>. The function encode the MB's syntax into bitstream and generate reconstruct data, which will be used as reference for later frame. For more detail please refer to <a href="https://huyunf.github.io/blogs/2017/12/12/x264_mb_analyse_and_coding/">x264 MB Analyse and Coding</a></p>
</li>
<li>
<p>several steps for entropy <code>cabac</code> or <code>cavlc</code> engine. </p>
</li>
<li>
<p>save context into cache <code>x264_macroblock_cache_save</code></p>
</li>
<li>
<p>mb level rate control <code>x264_ratecontrol_mb</code> <a href="https://huyunf.github.io/blogs/2017/12/05/x264_rate_control/">x264 rate control</a></p>
</li>
<li>
<p>several steps for accumulating mb stats</p>
</li>
<li>
<p>calculate deblock strength values <code>x264_macroblock_deblock_strength</code>. actual deblocking is done per-row along with hpel</p>
</li>
</ol>
<p>After the while loop for each MB, several step for </p>
<ol>
<li>
<p>deblocking for last row</p>
</li>
<li>
<p>end of entropy coding engine</p>
</li>
</ol>
<h4><strong>Reference Doc</strong></h4>
<hr>
<p>Doc of <a href="https://huyunf.github.io/blogs/2017/11/14/x264_overview/overview_x264_v8_5.pdf">X264 Overview</a></p>
            </div><!-- /.entry-content -->
            <div class="comments">
              <h3>Comments</h3>
              <div id="disqus_thread"></div>
              <script type="text/javascript">
                var disqus_identifier = "blogs/2017/11/14/x264_overview/";
                (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://huyunf.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
              </script>
            </div>


        </div><!-- /.eleven.columns -->

<div class="three columns">

<h4>Pages</h4>

 <ul>
      <li><a href="https://huyunf.github.io/pages/about.html">About</a></li>
  </ul>

<h4>Categories</h4>
<ul class="blank">
		<li><a href="https://huyunf.github.io/category/life.html">Life</a></li>
		<li><a href="https://huyunf.github.io/category/technology.html">Technology</a></li>
</ul>


<h4>Tags</h4>
	<ul class="blank">
	    <li class="tag-4"><a href="https://huyunf.github.io/tag/pelican.html">Pelican</a></li>
	    <li class="tag-1"><a href="https://huyunf.github.io/tag/h264.html">h264</a></li>
	    <li class="tag-4"><a href="https://huyunf.github.io/tag/travel.html">Travel</a></li>
	    <li class="tag-1"><a href="https://huyunf.github.io/tag/x264.html">x264</a></li>
	    <li class="tag-1"><a href="https://huyunf.github.io/tag/video-codec.html">Video Codec</a></li>
	    <li class="tag-4"><a href="https://huyunf.github.io/tag/web.html">web</a></li>
</ul>


<nav class="widget">
  <h4>Social</h4>
  <ul class="blank">
    <li><a href="https://github.com/huyunf">Github</a></li>
    <li><a href="https://www.facebook.com/">Facebook</a></li>
    <li><a href="https://twitter.com/">Twitter</a></li>
  </ul>
</nav>

</div> </div><!-- /.row -->


</section>

       </div><!-- /.row -->
    </div><!-- /.container -->


       <div class="container.nopad bg">

    
        <footer id="credits" class="row">
          <div class="seven columns left-center">

                   <address id="about" class="vcard body">
                    Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                    which takes great advantage of <a href="http://python.org">Python</a>.
                    <br />
                    Based on the <a target="_blank" href="http://gumbyframework.com">Gumby Framework</a>
                    </address>
          </div>


          <div class="seven columns">
            <div class="row">
              <ul class="socbtns">

                <li><div class="btn primary"><a href="https://github.com/huyunf" target="_blank">Github</a></div></li>




              </ul>
            </div>
          </div>
        </footer>

    </div>


<script type="text/javascript">
    var disqus_shortname = 'huyunf';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
  <script src="https://huyunf.github.io/theme/js/libs/jquery-1.9.1.min.js"></script>
  <script src="https://huyunf.github.io/theme/js/libs/gumby.min.js"></script>
  <script src="https://huyunf.github.io/theme/js/plugins.js"></script>
</body>
</html>